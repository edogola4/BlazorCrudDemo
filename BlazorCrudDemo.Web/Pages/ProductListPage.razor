@using BlazorCrudDemo.Web.Utilities
@page "/products"
@using BlazorCrudDemo.Shared.DTOs
@using BlazorCrudDemo.Web.Services
@using BlazorCrudDemo.Web.Components

<div class="container-fluid py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="d-flex align-items-center mb-2">
                        <div class="me-3">
                            <i class="bi bi-box-seam text-primary" style="font-size: 2.5rem;"></i>
                        </div>
                        <div>
                            <h1 class="h3 mb-0 text-gray-800">Products</h1>
                            <p class="text-muted">Manage your product inventory</p>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" @onclick="NavigateToCreate">
                    <i class="fas fa-plus me-2"></i>Add New Product
                </button>
            </div>
        </div>
    </div>

    <!-- Filters and Search Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="mb-0">
                        <i class="bi bi-funnel me-2"></i>Filters & Search
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <!-- Search Bar -->
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text"
                                       class="form-control"
                                       placeholder="Search products..."
                                       @bind="SearchTerm"
                                       @bind:event="oninput"
                                       @onkeydown="HandleSearchKeyDown" />
                                @if (!string.IsNullOrEmpty(SearchTerm))
                                {
                                    <button class="btn btn-outline-secondary" type="button" @onclick="ClearSearch">
                                        <i class="fas fa-times"></i>
                                    </button>
                                }
                            </div>
                        </div>

                        <!-- Category Filter -->
                        <div class="col-md-3">
                            <select class="form-select" @bind="SelectedCategoryId" @bind:event="onchange">
                                <option value="">All Categories</option>
                                @foreach (var category in Categories)
                                {
                                    <option value="@category.Id">@category.Name</option>
                                }
                            </select>
                        </div>

                        <!-- Sort Options -->
                        <div class="col-md-3">
                            <select class="form-select" @bind="SortBy" @bind:event="onchange">
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                                <option value="price-asc">Price (Low-High)</option>
                                <option value="price-desc">Price (High-Low)</option>
                                <option value="created-desc">Newest First</option>
                                <option value="created-asc">Oldest First</option>
                                <option value="stock-desc">Stock (High-Low)</option>
                            </select>
                        </div>

                        <!-- View Toggle -->
                        <div class="col-md-2">
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" id="view-table" @bind="ViewMode" @bind:event="oninput" />
                                <label class="btn btn-outline-primary" for="view-table">
                                    <i class="fas fa-list"></i>
                                </label>

                                <input type="radio" class="btn-check" id="view-grid" @bind="ViewMode" @bind:event="oninput" />
                                <label class="btn btn-outline-primary" for="view-grid">
                                    <i class="fas fa-th"></i>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bulk Actions Bar -->
    @if (SelectedProducts.Any())
    {
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-info d-flex align-items-center justify-content-between">
                    <span>
                        <strong>@SelectedProducts.Count</strong> product@(SelectedProducts.Count == 1 ? "" : "s") selected
                    </span>
                    <div>
                        <button class="btn btn-sm btn-outline-danger me-2" @onclick="ShowBulkDeleteConfirmation">
                            <i class="fas fa-trash me-1"></i>Delete Selected
                        </button>
                        <button class="btn btn-sm btn-outline-success" @onclick="ExportSelectedToCsv">
                            <i class="fas fa-download me-1"></i>Export CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Content Area -->
    <div class="row">
        <div class="col-12">
            @if (IsLoading)
            {
                <!-- Loading Skeleton -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        @if (ViewMode == "table")
                        {
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th><div class="skeleton" style="height: 20px; width: 100px;"></div></th>
                                            <th><div class="skeleton" style="height: 20px; width: 150px;"></div></th>
                                            <th><div class="skeleton" style="height: 20px; width: 80px;"></div></th>
                                            <th><div class="skeleton" style="height: 20px; width: 100px;"></div></th>
                                            <th><div class="skeleton" style="height: 20px; width: 120px;"></div></th>
                                            <th><div class="skeleton" style="height: 20px; width: 100px;"></div></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for (int i = 0; i < 5; i++)
                                        {
                                            <tr>
                                                <td><div class="skeleton" style="height: 60px; width: 60px; border-radius: 8px;"></div></td>
                                                <td><div class="skeleton" style="height: 20px; width: 200px;"></div></td>
                                                <td><div class="skeleton" style="height: 20px; width: 100px;"></div></td>
                                                <td><div class="skeleton" style="height: 20px; width: 80px;"></div></td>
                                                <td><div class="skeleton" style="height: 20px; width: 60px;"></div></td>
                                                <td><div class="skeleton" style="height: 30px; width: 80px;"></div></td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <!-- Grid Skeleton -->
                            <div class="row">
                                @for (int i = 0; i < 8; i++)
                                {
                                    <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                                        <div class="card">
                                            <div class="skeleton" style="height: 200px; width: 100%;"></div>
                                            <div class="card-body">
                                                <div class="skeleton" style="height: 20px; width: 80%; margin-bottom: 8px;"></div>
                                                <div class="skeleton" style="height: 16px; width: 60%; margin-bottom: 12px;"></div>
                                                <div class="skeleton" style="height: 24px; width: 40%;"></div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            }
            else if (!ProductsList.Any() && !HasActiveFilters)
            {
                <!-- Empty State -->
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <div class="empty-state-icon mb-4">
                            <i class="fas fa-box-open fa-4x text-muted"></i>
                        </div>
                        <h4 class="text-muted">No Products Found</h4>
                        <p class="text-muted mb-4">Get started by adding your first product to the inventory.</p>
                        <button class="btn btn-primary" @onclick="NavigateToCreate">
                            <i class="fas fa-plus me-2"></i>Add Your First Product
                        </button>
                    </div>
                </div>
            }
            else if (!ProductsList.Any() && HasActiveFilters)
            {
                <!-- No Results State -->
                <div class="card shadow-sm">
                    <div class="card-body text-center py-5">
                        <div class="empty-state-icon mb-4">
                            <i class="fas fa-search fa-4x text-muted"></i>
                        </div>
                        <h4 class="text-muted">No Products Match Your Filters</h4>
                        <p class="text-muted mb-4">Try adjusting your search criteria or clearing filters.</p>
                        <button class="btn btn-outline-primary" @onclick="ClearAllFilters">
                            <i class="fas fa-filter me-2"></i>Clear Filters
                        </button>
                    </div>
                </div>
            }
            else
            {
                <!-- Products Content -->
                <div class="card shadow-sm">
                    <div class="card-body">
                        @if (ViewMode == "table")
                        {
                            <!-- Table View -->
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th class="text-center">
                                                <input type="checkbox"
                                                       class="form-check-input"
                                                       @onclick="ToggleSelectAll"
                                                       checked="@(SelectedProducts.Count == ProductsList.Count && ProductsList.Any())"
                                                       indeterminate="@(SelectedProducts.Any() && SelectedProducts.Count < ProductsList.Count)" />
                                            </th>
                                            <th>Product</th>
                                            <th>Category</th>
                                            <th>Price</th>
                                            <th>Stock</th>
                                            <th>Status</th>
                                            <th class="text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var product in ProductsList)
                                        {
                                            <tr class="@GetRowClass(product)" @onclick="() => ToggleProductSelection(product.Id)">
                                                <td class="text-center">
                                                    <input type="checkbox"
                                                           class="form-check-input"
                                                           checked="@SelectedProducts.Contains(product.Id)"
                                                           @onclick="() => ToggleProductSelection(product.Id)"
                                                           @onclick:stopPropagation="true" />
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <div class="product-thumbnail me-3">
                                                            @if (!string.IsNullOrEmpty(product.ImageUrl))
                                                            {
                                                                <img src="@product.ImageUrl"
                                                                     alt="@product.Name"
                                                                     class="img-thumbnail"
                                                                     style="width: 60px; height: 60px; object-fit: cover;" />
                                                            }
                                                            else
                                                            {
                                                                <div class="img-thumbnail d-flex align-items-center justify-content-center bg-light"
                                                                     style="width: 60px; height: 60px;">
                                                                    <i class="fas fa-image fa-2x text-muted"></i>
                                                                </div>
                                                            }
                                                        </div>
                                                        <div>
                                                            <h6 class="mb-0">@product.Name</h6>
                                                            <small class="text-muted">@product.SKU</small>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="badge bg-light text-dark">@product.CategoryName</span>
                                                </td>
                                                <td>
                                                    <span class="fw-bold text-success">@CurrencyFormatter.FormatPrice(product.Price)</span>
                                                </td>
                                                <td>
                                                    <span class="@GetStockClass(product)">@product.Stock in stock</span>
                                                </td>
                                                <td>
                                                    <span class="badge @GetStatusBadgeClass(product)">@product.AvailabilityStatus</span>
                                                </td>
                                                <td class="text-center">
                                                    <div class="btn-group" role="group">
                                                        <button class="btn btn-sm btn-outline-primary"
                                                                @onclick="() => ViewProduct(product.Id)"
                                                                @onclick:stopPropagation="true"
                                                                title="View Details">
                                                            <i class="fas fa-eye"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-secondary"
                                                                @onclick="() => EditProduct(product.Id)"
                                                                @onclick:stopPropagation="true"
                                                                title="Edit Product">
                                                            <i class="fas fa-edit"></i>
                                                        </button>
                                                        <button class="btn btn-sm btn-outline-danger"
                                                                @onclick="() => ShowDeleteConfirmation(product)"
                                                                @onclick:stopPropagation="true"
                                                                title="Delete Product">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <!-- Grid View -->
                            <div class="row">
                                @foreach (var product in ProductsList)
                                {
                                    <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                                        <div class="card h-100 product-card @GetCardClass(product)" @onclick="() => ViewProduct(product.Id)">
                                            <div class="position-relative">
                                                @if (!string.IsNullOrEmpty(product.ImageUrl))
                                                {
                                                    <img src="@product.ImageUrl"
                                                         alt="@product.Name"
                                                         class="card-img-top product-image"
                                                         loading="lazy" />
                                                }
                                                else
                                                {
                                                    <div class="card-img-top d-flex align-items-center justify-content-center bg-light product-image">
                                                        <i class="fas fa-image fa-3x text-muted"></i>
                                                    </div>
                                                }
                                                <div class="card-img-overlay d-flex justify-content-end p-2">
                                                    <input type="checkbox"
                                                           class="form-check-input"
                                                           checked="@SelectedProducts.Contains(product.Id)"
                                                           @onclick="() => ToggleProductSelection(product.Id)"
                                                           @onclick:stopPropagation="true" />
                                                </div>
                                            </div>
                                            <div class="card-body d-flex flex-column">
                                                <h6 class="card-title mb-2">@product.Name</h6>
                                                <p class="card-text text-muted small mb-2">@product.CategoryName</p>
                                                <div class="mt-auto">
                                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                                        <span class="h5 text-success mb-0">@CurrencyFormatter.FormatPrice(product.Price)</span>
                                                        <span class="badge @GetStatusBadgeClass(product) small">@product.AvailabilityStatus</span>
                                                    </div>
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <small class="text-muted">@product.Stock in stock</small>
                                                        <div class="btn-group btn-group-sm" role="group">
                                                            <button class="btn btn-outline-secondary"
                                                                    @onclick="() => EditProduct(product.Id)"
                                                                    @onclick:stopPropagation="true">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button class="btn btn-outline-danger"
                                                                    @onclick="() => ShowDeleteConfirmation(product)"
                                                                    @onclick:stopPropagation="true">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>

                <!-- Pagination -->
                @if (TotalPages > 1)
                {
                    <div class="card-footer">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <label class="form-label me-2 mb-0">Show:</label>
                                    <select class="form-select form-select-sm" @bind="PageSize" @bind:event="onchange" style="width: auto;">
                                        <option value="10">10</option>
                                        <option value="25">25</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                    </select>
                                    <span class="ms-2 text-muted">items per page</span>
                                </div>
                            </div>
                            <div class="col-md-4 text-center">
                                <span class="text-muted">
                                    Showing @(ProductsList.Any() ? ((CurrentPage - 1) * PageSize) + 1 : 0) - @(Math.Min(CurrentPage * PageSize, TotalCount)) of @TotalCount products
                                </span>
                            </div>
                            <div class="col-md-4">
                                <nav aria-label="Product pagination">
                                    <ul class="pagination pagination-sm justify-content-end mb-0">
                                        <li class="page-item @(CurrentPage == 1 ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => GoToPage(1)" disabled="@(CurrentPage == 1)">« First</button>
                                        </li>
                                        <li class="page-item @(CurrentPage == 1 ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => GoToPage(CurrentPage - 1)" disabled="@(CurrentPage == 1)">‹ Previous</button>
                                        </li>

                                        @for (int i = Math.Max(1, CurrentPage - 2); i <= Math.Min(TotalPages, CurrentPage + 2); i++)
                                        {
                                            <li class="page-item @(i == CurrentPage ? "active" : "")">
                                                <button class="page-link" @onclick="() => GoToPage(i)">@i</button>
                                            </li>
                                        }

                                        <li class="page-item @(CurrentPage == TotalPages ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => GoToPage(CurrentPage + 1)" disabled="@(CurrentPage == TotalPages)">Next ›</button>
                                        </li>
                                        <li class="page-item @(CurrentPage == TotalPages ? "disabled" : "")">
                                            <button class="page-link" @onclick="() => GoToPage(TotalPages)" disabled="@(CurrentPage == TotalPages)">Last »</button>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
@if (ShowDeleteModal)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Deletion</h5>
                    <button type="button" class="btn-close" @onclick="HideDeleteModal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete <strong>@ProductToDelete?.Name</strong>?</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        This action cannot be undone.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="HideDeleteModal">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmDelete" disabled="@IsDeleting">
                        @if (IsDeleting)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Delete Product
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Bulk Delete Confirmation Modal -->
@if (ShowBulkDeleteModal)
{
    <div class="modal fade show d-block" style="background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Bulk Deletion</h5>
                    <button type="button" class="btn-close" @onclick="HideBulkDeleteModal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete <strong>@SelectedProducts.Count</strong> selected product@(SelectedProducts.Count == 1 ? "" : "s")?</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        This action cannot be undone.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="HideBulkDeleteModal">Cancel</button>
                    <button type="button" class="btn btn-danger" @onclick="ConfirmBulkDelete" disabled="@IsDeleting">
                        @if (IsDeleting)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Delete @SelectedProducts.Count Product@(SelectedProducts.Count == 1 ? "" : "s")
                    </button>
                </div>
            </div>
        </div>
    </div>
}


<style>
    .skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
    }

    @@keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    .product-thumbnail {
        transition: transform 0.2s ease;
    }

    .product-thumbnail:hover {
        transform: scale(1.05);
    }

    .product-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .product-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .product-image {
        height: 200px;
        object-fit: cover;
    }

    .empty-state-icon {
        opacity: 0.5;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(0,123,255,0.1);
    }

    /* Mobile responsiveness */
    @@media (max-width: 768px) {
        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .product-image {
            height: 150px;
        }

        .card-title {
            font-size: 1rem;
        }
    }
}
</style>
