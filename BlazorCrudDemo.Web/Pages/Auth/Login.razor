@page "/auth/login"
@using System
@using System.Security.Claims
@using System.Collections.Generic
@using Microsoft.AspNetCore.WebUtilities
@using BlazorCrudDemo.Web.Services
@using BlazorCrudDemo.Shared.DTOs
@using BlazorCrudDemo.Shared.Models
@inject NavigationManager Navigation
@inject IAuthenticationService AuthenticationService
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Login</PageTitle>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-4">
            <div class="card shadow">
                <div class="card-body">
                    <h2 class="card-title text-center mb-4">Login</h2>

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger" role="alert">
                            @errorMessage
                        </div>
                    }

                    <form @onsubmit="HandleLoginAsync">
                        <div class="mb-3">
                            <label for="email" class="form-label">Email</label>
                            <input type="email" class="form-control" id="email" @bind="email" required>
                        </div>

                        <div class="mb-3">
                            <label for="password" class="form-label">Password</label>
                            <input type="password" class="form-control" id="password" @bind="password" required>
                        </div>

                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="rememberMe" @bind="rememberMe">
                            <label class="form-check-label" for="rememberMe">Remember me</label>
                        </div>

                        <input type="hidden" name="returnUrl" value="@returnUrl">

                        <button type="submit" class="btn btn-primary w-100" disabled="@isLoading">
                            @if (isLoading)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            }
                            Log in
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string errorMessage = "";
    private bool isLoading = false;
    private string returnUrl = "";
    private string email = string.Empty;
    private string password = string.Empty;
    private bool rememberMe = false;

    protected override async Task OnInitializedAsync()
    {
        // Check if user is already authenticated
        var isAuthenticated = await AuthenticationService.IsAuthenticatedAsync();
        if (isAuthenticated)
        {
            Navigation.NavigateTo("/");
            return;
        }

        // Check for return URL parameter
        var uri = new Uri(Navigation.Uri);
        var queryParams = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
        returnUrl = queryParams.FirstOrDefault(p => p.Key == "returnUrl").Value.ToString() ?? "";
    }

    // AuthenticationStateProvider is now injected at the top

    private async Task HandleLoginAsync()
    {
        try
        {
            errorMessage = string.Empty;
            isLoading = true;

            var dto = new LoginDto
            {
                Email = email,
                Password = password,
                RememberMe = rememberMe
            };

            var result = await AuthenticationService.LoginAsync(dto);

            if (result.Success)
            {
                // Notify the authentication state provider that the user is authenticated
                if (AuthenticationStateProvider is CustomAuthenticationStateProvider customAuthProvider)
                {
                    var user = await AuthenticationService.GetCurrentUserAsync();
                    if (user != null)
                    {
                                    var claims = new List<Claim>
                        {
                            new Claim(ClaimTypes.Name, user.Email ?? string.Empty),
                            new Claim(ClaimTypes.Email, user.Email ?? string.Empty),
                            new Claim(ClaimTypes.NameIdentifier, user.Id ?? string.Empty)
                        };
                        
                        // Add roles as individual claims
                        if (user.Roles != null)
                        {
                            foreach (var role in user.Roles)
                            {
                                claims.Add(new Claim(ClaimTypes.Role, role));
                            }
                        }
                        
                        var identity = new ClaimsIdentity(claims, "apiauth");
                        
                        var principal = new ClaimsPrincipal(identity);
                        customAuthProvider.MarkUserAsAuthenticated(principal);
                        
                        // Add a small delay to ensure the auth state is updated
                        await Task.Delay(100);
                        
                        // Navigate to the target page with force load to ensure all components re-render
                        var target = string.IsNullOrWhiteSpace(returnUrl) ? "/" : returnUrl;
                        Navigation.NavigateTo(target, true);
                        return;
                    }
                }
                
                // Fallback to default navigation if something goes wrong
                Navigation.NavigateTo("/");
            }
            else
            {
                errorMessage = string.IsNullOrWhiteSpace(result.Message) ? "Invalid email or password." : result.Message;
            }
        }
        catch (Exception)
        {
            errorMessage = "An unexpected error occurred while attempting to log in.";
        }
        finally
        {
            isLoading = false;
        }
    }
}

